#
# © ОАО «Северное ПКБ», 2014
#
--- 
#- name: остановка сервисов ALD
#  service: name={{ item }} state=stopped
#  with_items: [krb5-kdc, krb5-admin-server, slapd, nscd, nslcd, aldcd, aldd]

- name: копирование файлов настроек для ALD
  copy: src=ald-conf/{{ common.master_node }}${item} dest=${item} backup=no
  with_items: ald_files

- name: удаление исходной схемы LDAP
  file: path=/etc/ldap/slapd.d state=absent

- name: копирование файлов схемы LDAP
  copy: src=ald-conf/{{ common.master_node }}/etc/ldap/slapd.d dest=/etc/ldap
        owner=openldap group=openldap

- name: установка прав на подкаталоги схемы
  file: path=/etc/ldap/${item} state=directory
          owner=openldap group=openldap mode=0750
  with_items:
    - slapd.d
    - slapd.d/cn=config
    - slapd.d/cn=config/cn=schema
    - slapd.d/cn=config/olcDatabase={2}hdb

- name: установка прав на файл ключа
  file: path=/etc/ldap/slapd.keytab state=file
        owner=openldap group=openldap mode=0400

- name: замена неверного файла /etc/init.d/nscd
  copy: src=nscd dest=/etc/init.d/nscd owner=root group=root mode=0755

#- name: добавление сервисов LDAP
#  command: ald-admin service-add {{ item }}/{{ inventory_hostname }}.{{ ald.domain }} -f --pass-file=/root/pass-file
#  with_items:
#    - ldap

#- name: добавление ключа для узла
#  command: ald-client update-svc-keytab host/{{ inventory_hostname }}.{{ ald.domain }} -f --pass-file=/root/pass-file --ktfile=/etc/krb5.keytab

#- name: подмена каталога /var/lib/ldap
#  file: src={{ gluster.mount_point }}/ldap dest=/var/lib/ldap state=link
#  mount: name=/var/lib/ldap src={{ gluster.mount_point }}/ldap
#         fstype=none opts=bind state=mounted

#- name: удаление старой базы Kerberos
#  command: rm -rf /var/lib/krb5kdc removes=/var/lib/krb5kdc

#- name: подмена каталога /var/lib/krb5kdc
#  file: src={{ gluster.mount_point }}/krb5kdc dest=/var/lib/krb5kdc state=link
#  mount: name=/var/lib/krb5kdc src={{ gluster.mount_point }}/krb5kdc
#         fstype=none opts=bind state=mounted

- name: создание каталога /var/log/kerberos
  file: path=/var/log/kerberos state=directory
        owner=root group=root mode=0700

